<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lv6 Spring WebSocket Chat Test</title>
</head>
<body>
<h2>Lv6 Chat Test</h2>

<div>
    Room ID: <input id="roomId" value="room1">
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</div>

<div>
    Name: <input id="sender" value="user1">
</div>

<div>
    Message: <input id="message">
    <button onclick="sendMessage()">Send</button>
</div>

<pre id="log" style="border:1px solid #ccc; padding:8px; height:200px; overflow:auto;"></pre>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let currentRoom = null;

    function log(msg) {
        const area = document.getElementById('log');
        area.textContent += msg + '\n';
        area.scrollTop = area.scrollHeight;
    }

    function connect() {
        const roomId = document.getElementById('roomId').value || 'room1';
        const socket = new SockJS('http://localhost:8080/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // 필요하면 로그 보고 싶을 때만 켜기

        stompClient.connect({}, function (frame) {
            log('Connected: ' + frame);
            currentRoom = roomId;

            // 방 구독
            stompClient.subscribe('/topic/rooms/' + roomId, function (message) {
                const body = JSON.parse(message.body);
                log('[' + body.roomId + '][' + body.type + '][' + body.sender + '] ' + body.content);
            });

            // 입장 알림
            const sender = document.getElementById('sender').value || 'user';
            stompClient.send('/app/chat.enter/' + roomId, {}, JSON.stringify({
                sender: sender,
                content: sender + ' joined',
                type: 'JOIN'
            }));
        }, function (error) {
            log('ERROR: ' + error);
        });
    }

    function disconnect() {
        if (stompClient) {
            stompClient.disconnect(function () {
                log('Disconnected');
            });
            stompClient = null;
            currentRoom = null;
        }
    }

    function sendMessage() {
        if (!stompClient || !currentRoom) {
            log('Not connected');
            return;
        }
        const sender = document.getElementById('sender').value || 'user';
        const content = document.getElementById('message').value || '';
        stompClient.send('/app/chat.sendMessage/' + currentRoom, {}, JSON.stringify({
            sender: sender,
            content: content,
            type: 'CHAT'
        }));
        document.getElementById('message').value = '';
    }
</script>
</body>
</html>